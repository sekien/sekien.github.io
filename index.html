<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>sekien.github.io</title>
  <!--link rel="stylesheet" href="css/styles.css?v=1.0"-->
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.4/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.4/leaflet.js"></script>

  <style>
    #map {
      width: 100%;
      height: 500px;
    }
  </style>

  <script>
  	$(function(){



      var map = L.map('map',{maxBounds:[[20, 123],[46, 154]]}).setView([36.3219088, 139.0032936], 5);

      var mylayer = L.tileLayer(
        'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
        {attribution: "<a href='http://www.gsi.go.jp/kikakuchousei/kikakuchousei40182.html' target='_blank'>国土地理院</a>"}
      ).addTo(map);

      var polyGroup = L.layerGroup().addTo(map);

      
      var Polyborder = function Polyborder(num) {

        var geojson;
        var prm = {};
        var cb = num;
        var ary = cb.split("/");
        var cba = [];

        if(ary.length > 6){
          cba = ary[6].split(".");
          prm = {
            type: 'GET',
            url: num,
            dataType: 'jsonp',
            jsonpCallback: 'callback'+cba[0],
          };
        }else{
          cba = ary[5].split(".");
          prm = {
            type: 'GET',
            url: num,
            dataType: 'jsonp',
            jsonpCallback: 'callbackp'+cba[0],
          };
        }

        $.ajax(prm,
        ).done(function (data){
          geojson = L.geoJson(data, {
            style: polystyle
          });
          geojson.addTo(polyGroup);

          //ポップアップ
          var geoname;
          if(data.features[0].properties.N03_003 != null){
            geoname = data.features[0].properties.N03_003 + data.features[0].properties.N03_004
          }else{
            geoname = data.features[0].properties.N03_004;
          }
          geojson.bindPopup('<p>'+geoname+'</p>');

          //バウンド
          map.fitBounds(geojson.getBounds());

          //境界線スタイル
          var polystyle = function polystyle(feature) {
            return {
              fillColor: '#5b6585',
              weight: 1,
              opacity: 0.9,
              color: '#5b6585',
              fillOpacity: 0.5,
              interactive: true//false
            };
          };

        }).fail(function (jqXHR, textStatus, errorThrown){
          console.log(num+"\n"+textStatus+"\n"+errorThrown);
        });

      };



      var getGeojson = function getGeojson(pref,area){

        var filepath = "";

        if(area != ""){
          $.ajax({
            url: 'http://youkaimap.php.xdomain.jp/gyouseikukaku/get_geojson_jsonp.php',
            dataType: 'jsonp',
            jsonpCallback: 'callbackgj',
            //dataType: 'text',
            //async: false,
            data: {
              p: pref,
              q: area
            }
          }).done(function (data) {

            $.each(JSON.parse(data),
              function(index, elem) {
                filepath = "https://sekien.github.io/administrative_division_japan/2019/"+elem.pref_id+"/"+elem.file_id+".geojson";
                Polyborder(filepath);
                //console.log(filepath);
            });
            
          }).fail(function(jqXHR, textStatus, errorThrown){
            console.log(textStatus);
          });
        }else{
          var _pref = parseInt(pref, 10);
          //filepath = "../json/pref/"+_pref+".geojson";
          filepath = "https://sekien.github.io/prefectures_japan/2019/"+_pref+".geojson";
          Polyborder(filepath);
        }

      }



      $("#areabtn").click(function(){
        var pf = $("[name=pref] option:selected").val();
        var an = $("[name=areaname]").val();
        polyGroup.clearLayers();
        getGeojson(pf,an);
      });









//JSONPファイルのテスト
   /*     
        $.ajax({
          type: 'GET',
          url: 'https://sekien.github.io/administrative_division_japan/2019/01/6077.geojson',
          dataType: 'jsonp',
          jsonpCallback: 'callback',
        }).done(function (data){
          console.log(data);

          geojson = L.geoJson(data, {
            style: polystyle
          });
          geojson.addTo(polyGroup);

          var geoname;
          if(data.features[0].properties.N03_003 != null){
            geoname = data.features[0].properties.N03_003 + data.features[0].properties.N03_004
          }else{
            geoname = data.features[0].properties.N03_004;
          }
          geojson.bindPopup('<p>'+geoname+'</p>');

          map.fitBounds(geojson.getBounds());

          var polystyle = function polystyle(feature) {
            return {
              fillColor: '#5b6585',
              weight: 1,
              opacity: 0.9,
              color: '#5b6585',
              fillOpacity: 0.5,
              interactive: true//false
            };
          };

        }).fail(function (jqXHR, textStatus, errorThrown){
          console.log(textStatus);
        });
      */

      
  	});
  </script>

</head>

<body>
  <div>
    <select name="pref">
      <option value="01">北海道</option>
      <option value="02">青森県</option>
      <option value="03">岩手県</option>
      <option value="04">宮城県</option>
      <option value="05">秋田県</option>
      <option value="06">山形県</option>
      <option value="07">福島県</option>
      <option value="08">茨城県</option>
      <option value="09">栃木県</option>
      <option value="10">群馬県</option>
      <option value="11">埼玉県</option>
      <option value="12">千葉県</option>
      <option value="13">東京都</option>
      <option value="14">神奈川県</option>
      <option value="15">新潟県</option>
      <option value="16">富山県</option>
      <option value="17">石川県</option>
      <option value="18">福井県</option>
      <option value="19">山梨県</option>
      <option value="20">長野県</option>
      <option value="21">岐阜県</option>
      <option value="22">静岡県</option>
      <option value="23">愛知県</option>
      <option value="24">三重県</option>
      <option value="25">滋賀県</option>
      <option value="26">京都府</option>
      <option value="27">大阪府</option>
      <option value="28">兵庫県</option>
      <option value="29">奈良県</option>
      <option value="30">和歌山県</option>
      <option value="31">鳥取県</option>
      <option value="32">島根県</option>
      <option value="33">岡山県</option>
      <option value="34">広島県</option>
      <option value="35">山口県</option>
      <option value="36">徳島県</option>
      <option value="37">香川県</option>
      <option value="38">愛媛県</option>
      <option value="39">高知県</option>
      <option value="40">福岡県</option>
      <option value="41">佐賀県</option>
      <option value="42">長崎県</option>
      <option value="43">熊本県</option>
      <option value="44">大分県</option>
      <option value="45">宮崎県</option>
      <option value="46">鹿児島県</option>
      <option value="47">沖縄県</option>
    </select>
    <input type="text" name="areaname" value="">
    <button id="areabtn">表示</button>
  </div>
  <div id="map"></div>

</body>
</html>